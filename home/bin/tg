#!/bin/bash

# GOAL
# - Make it easy to run "terragrunt" commands
#   after calling set_env.sh to set up the env vars.
# - Make it easy to run some simple or more complex
#   sets of commands quickly (e.g. tg -A)

#set -x
set -e

# Check if we are inside a git repository
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  echo "Error: This script must be run within a git repository."
  exit 1
fi

# Source the Framework Environment file
. $(git rev-parse --show-toplevel)/set_env.sh

# Confirm that terragrunt is version 0.99 or higher
TG_VERSION=$(terragrunt --version)
[[ $(echo "$TG_VERSION" | grep -oE '[0-9]+\.[0-9]+' | head -n1) > 0.98 ]] && echo "TG Version OK" || echo "TG Version Too Old"


# "remove all terraform/terragrunt files"
remove-files() {
    rm -rf ./.terraform
    rm -f ./.terraform.lock.hcl
    rm -f ./terraform.tfstate*
    rm -rf ./.terragrunt-cache
    rm ./*# ./*~
}

# TODO: update this for all clouds, based on the active config.
show-user() {
    # "Check that the AWS ClI is working, and which user is connecting"
    aws sts get-caller-identity | jq .
    aws ram list-resources  --resource-owner SELF
}

destroy() {
    time terragrunt destroy -auto-approve 2>&1 | tee ~/.tf-destroy.log
    rm -f .tfplan
}

show-output() {
    F=~/.tf-output.json
    terragrunt output -json > $F
    cat ~/.tf-output.json | jq .
    echo "Output shown above was written to $F"
}

show-inputs() {
    terragrunt render --all --json | jq '.inputs'
}

format() {
    # Set TF
    if command -v tofu; then
        TF='tofu'
    elif command -v terraform; then
        TF='terraform'
    else
        echo "tofu and terraform are not in PATH"
        exit 1
    fi

    $TF fmt -recursive .

    terragrunt hcl fmt \
      --exclude-dir ".terragrunt-cache" \
      --exclude-dir ".terraform"
}

# This is necessary if the module source (contents or paths) are changed
upgrade() {
    terragrunt run --all init -- --upgrade
}

validate() {
    terragrunt validate
}

plan() {
    terragrunt plan
}

apply() {
    # Make the log output look like the actual underlying tofu/terraform log output
    #export TG_LOG_FORMAT=bare

    # As of Terragrunt v0.99
    #
    # With debug info
    #terragrunt run --all apply --non-interactive --log-level debug --  2>&1 | tee ~/.tf-apply.log
    #
    terragrunt run --all apply --non-interactive --  2>&1 | tee ~/.tf-apply.log
}

apply_and_show_json() {
    # As of Terragrunt v0.99
    # Format Terragrunt logs and terraform/tofu output in json
    terragrunt run --all apply --non-interactive --log-level debug --log-format json -- -json 2>&1 | tee ~/.tf-apply.log.json | jq '.'
}

show_usage() {
    cat <<EOF
Usage: $0 arg

Args with their long-forms
        -p|--plan (upgrade, validate, plan)
        -a|--apply (apply)
        -x|--execute (equivalent to -p -a)
        -j|--apply-and-show-json (apply, with debugging on, with output logs as json)
        -f|--format
        -i|--show-inputs
        -o|--show-output
        # Destructive
        -D|--destroy (terraform destroy -auto-approve)
        -R|--destroy-and-remove-files (-D and remove terraform and terragrunt caches)
        #
        -U|--user (show user) TODO: update for the new code and providers
        #
        -h|--help
EOF
}

################################################################################

if [[ $# -eq 0 ]]; then
    show_usage
    exit 1
fi

while [[ $# -gt 0 ]]; do
    key="$1"

    case $key in
        -p|--plan)
            shift
            upgrade
            validate
            plan
            ;;
        -a|--apply)
            shift
            apply
            ;;
        -j|--apply-and-show-json)
            shift
            apply_and_show_json
            ;;
        -x|--execute)
            shift
            upgrade
            validate
            plan
            apply
            ;;
        -f|--format)
            shift
            format
            ;;
	      -h|--help)
            show_usage
            shift
            ;;
        -i|--show-inputs)
            shift
            show-inputs
            ;;
        -o|--show-output)
            shift
            show-output
            ;;
        -u|--upgrade)
            shift
            upgrade
            ;;
        -D|--destroy)
            shift
            destroy
            ;;
        -R|--destroy-and-remove-files)
            shift
            destroy
            remove-files
            ;;
        -U|--user)
            shift
            show-user
            ;;
        *)
            echo "unknown option '$1'"
            show_usage
            exit 1
            ;;
    esac
done
